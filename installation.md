# OpenIMS installation
OpenIMS 安裝與測試流程

# Requirements
## Hardware
1. 現今相容Linux硬體或VM都可以
2. 依Linux運行所需之RAM與Storage空間
## Network access
- Inter-domain NAT is not something we are interested in, so a public IP address would be great
- Controllable DNS server if you don't want to have one on your Linux
## Software
- ~100 MBytes of disk space to be on the safe side
- GCC3/4, make, JDK1.5, ant
- MySQL installed and started (or other DBMS if you can deal with it)
- bison, flex
- libxml2 (> 2.6), libmysql - both with development
- Linux kernel 2.6 and ipsec-tools (setkey) if you want to use IPSec security
- Optional: openssl if you would like to enable the TLS security
- bind installed and running (or other name server if you can deal with it)
- Browser on the box or that can connect to the box (for user provisioning)
#### OS版本目前測試Ubuntu14.04LTS安裝環境問題最少

# How to install
- First, install these software in the terminal, type
```
sudo apt-get install subversion ant default-jre default-jdk bison flex mysql-server libmysqlclient-dev libxml2 libxml2-dev bind9 ipsec-tools libcurl4-openssl-dev libgstreamer0.10-dev gstreamer0.10-plugins-farsight gstreamer0.10-plugins-bad libgstreamer-plugins-base0.10-dev rcconf sysv-rc-conf -y
```
- Second, update the system
```
sudo apt-get update -y
sudo apt-get upgrade -y
sudo apt-get dist-upgrade -y
```
## Step 1: Get the Source Code
- Start the Linux terminal
- Create /opt/OpenIMSCore and go there
```
mkdir /opt/OpenIMSCore
cd /opt/OpenIMSCore
mkdir ser_ims
mkdir FHoSS
sudo chmod 777 -R /opt
```
- Create a new directory ser_ims and checkout the CSCFs there
```
svn checkout https://svn.code.sf.net/p/openimscore/code/ser_ims/trunk ser_ims

```
- Create a new directory FHoSS and checkout the HSS there
```$svn checkout https://svn.code.sf.net/p/openimscore/code/FHoSS/trunk FHoSS
```
## Step 2: Compile
### ser_ims
- Do "make install-libs all" in ser_ims 
```
cd ser_ims
sudo make install-libs all
cd ..
```
- If something breaks, you probably don't have all the prerequisites.
### FHoSS
- If you don't have a JDK >=1.5, get one before proceeding 
```
java -version
```
- Do "ant compile deploy" in FHoSS
```
cd FHoSS
ant compile
ant deploy
cd ..
```
## Step 3: Configure the Environment
### Note
- All the installation examples configured to work only on the local loopback and the default domain configured as "open-ims.test".
- Replace 127.0.0.1 where required with your IP address.
### DNS
- A sample DNS zone file can be found in ser_ims/cfg/open-ims.dnszone
- Copy it to your bind configuration directory(/etc/bind)
```
sudo cp ser_ims/cfg/open-ims.dnszone /etc/bind
```
### Change IP address and domain name in open-ims.dnszone file(in /etc/bind) 
- 所有的127.0.0.1改成自己的IP
- 所有的open-ims.test改成自己的domain name
```
cd /etc/bind
sudo vim open-ims.dnszone
```
- Edit /etc/bind/named.conf and insert the file there
```
sudo vim /etc/bind/named.conf
```
```
zone "open-ims.test" { 
    type master; file "/etc/bind/open-ims.dnszone"; 
    };
```
- Don't forget about /etc/resolv.conf pointing to your new DNS server
```
sudo vim /etc/resolv.conf
```
```
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
search your.domain.name
domain your.domain.name
nameserver your.ip.address
```
- ser_ims/cfg/configurator.sh lets you to change IP address and domain name in the ser_ims/cfg/*.cfg, ser_ims/cfg/*.xml, ser_ims/cfg/*.sh files
```
cd /opt/OpenIMSCore/ser_ims/cfg
sudo sh configurator.sh

Domain Name: your.domain.name
IP Address: your.IP.address
File to change [“all” for everything, “exit” to quit]: all
```
- Take a look at the configuration files in  /FHoSS/deploy/DiameterPeerHSS.xml,/FHoSS/scripts/userdara.sql, and /FHoSS/config/DiameterPeerHSS.xml(change domain name and IP address to what you want)
```
sudo vim /opt/OpenIMSCore/FHoSS/deploy/DiameterPeerHSS.xml
sudo vim /opt/OpenIMSCore/FHoSS/scripts/userdata.sql
sudo vim /opt/OpenIMSCore/FHoSS/config/DiameterPeerHSS.xml
```
- Restart the name server (bind9)
```
sudo service bind9 restart
```
- Test that the names are resolvable: 
```
ping your.domain.name
```
### 綁定DNS
- 至ubuntu的網卡設定 ipv4 dhcp改成manual, ip addr,mask,gateway皆須設定
- 執行rcconf和sysv-rc-conf,resolv都要關掉(沒有星號)
- 修改 vim /etc/resolvconf/resolv.conf.d/base,加入nameserver 自己IP
### MySQL
- Type the MySQL comands:
```
mysql -u root -p -h localhost < /opt/OpenIMSCore/ser_ims/cfg/icscf.sql
mysql -u root -p -h localhost < /opt/OpenIMSCore/FHoSS/scripts/hss_db.sql
mysql -u root -p -h localhost < /opt/OpenIMSCore/FHoSS/scripts/userdata.sql
```
> icscf.sql:儲存各s-cscf的ip address及其具備的功能

> hss_db.sql:儲存HSS資料庫的表格框架

> userdata.sql:儲存使用者的帳號及密碼等相關資料，如果匯入資料有錯誤，請在 Line 41 最後面補兩個0
## Step 4: Configure the IMS Core
- By now you should have MySQL and DNS working
- Copy the following files to /opt/OpenIMSCore:
> pcscf.cfg, pcscf.sh, icscf.cfg, icscf.xml, icscf.sh, scscf.cfg, scscf.xml, scscf.sh
```
cd /opt/OpenIMSCore
cp ser_ims/cfg/*.cfg ./
cp ser_ims/cfg/*.xml ./
cp ser_ims/cfg/*.sh ./
```
## Step 5: Start the components
### PCSCF ICSCF SCSCF
- open 3 new terminals and type 
```
. /opt/OpenIMSCore/icscf.sh 
. /opt/OpenIMSCore/pcscf.sh 
. /opt/OpenIMSCore/scscf.sh 
```
### FHoSS 
```
. /opt/OpenIMSCore/fhoss.sh
(需root權限)
(fhoss.sh執行前需另外執行scscf.sh icscf.sh pcscf.sh
)
```
Check the web interface on http://localhost:8080/

Username: hssAdmin 

password: hss
- If error occur. Can not find /bin/java
```
sudo ln -s /usr/bin/java /bin/java
```
## Step 6: Configure Subscribers
By default, FHoSS comes provisioned with a couple of sample users:
```
alice@open-ims.test
-Account: alice
-Passward: alice
```
```
bob@open-ims.test
-Account: bob
-Passward: bob
```
## Step 7: Test!
### install wireshark on Ubunutu
```
sudo add-apt-repository ppa:wireshark-dev/stable
sudo apt-get update
sudo apt-get install wireshark
sudo adduser $USER wireshark
```
Then login again or reboot 

Use Wireshark to see what's going on: 
- Monitor ports 4060, 5060 and 6060 for SIP traffic
- Monitor ports 3868, 3869 and 3870 for Diameter traffic

For detail guide, please refer to:
[multi-p2p - InstallOpenIMSCoreandMobicentsAS.wiki](https://code.google.com/archive/p/multi-p2p/wikis/InstallOpenIMSCoreandMobicentsAS.wiki)

### 執行PCSCF ICSCF SCSCF和FHOSS
Check the web interface on http://localhost:8080/
### 安裝Boghe IMS Client
[Boghe 下載](http://boghe-ims-client.software.informer.com/download/)
#### Run Boghe IMS Client
- Take Bob as example:
- Display name: Bob
- Public identity:  sip:bob@your.domain.name
- Private identity:  bob@your.domain.name
- password: bob
- PCSCF Host: pcscf. your.domain.name 
- PCSCF port: 4060

#### Start two clients at the same time, set one as Alice, another one as Bob.
#### Login them to the Open IMS core.

# Ref
[FOKUS Open IMS Core](http://www.openimscore.org/)

[Install OpenIMSCore and Mobicents AS](https://code.google.com/p/multi-p2p/wiki/InstallOpenIMSCoreandMobicentsAS)

[解決 Ubuntu Server /etc/resolv.conf 自動還原的問題](http://blog.ilc.edu.tw/blog/index.php?op=printView&articleId=507773&blogId=25793)

[Wireshark 安裝使用 for Ubuntu](https://self.jxtsai.info/2016/10/wireshark-for-ubuntu.html)
